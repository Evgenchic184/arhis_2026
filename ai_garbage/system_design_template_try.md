# ML System Design Doc - Sentiment Support System MVP v1

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*

### 1. Цели и предпосылки

#### 1.1. Зачем идем в разработку продукта?

Автоматически выявлять пользователей с негативным эмоциональным состоянием по комментариям и отправлять им поддерживающие сообщения.

Без ML невозможно масштабировать ручную модерацию комментариев. ML позволяет обрабатывать большой поток данных в реальном времени.

Система классифицирует комментарии с приемлемой точностью и отправляет поддерживающие фразы не более чем за 5–10 секунд.

#### 1.2. Бизнес-требования и ограничения

**Требования:**
- Определять настроение пользователя по комментарию
- Отправлять фразу поддержки всем пользователям с негативным настроением

**Ограничения:**
- Время ответа: 5-10 секунд
- Онлайн-режим работы
- В версии v0 все комментарии считаются грустными (baseline)

**Поток:**
```
Комментарий → классификация → отправка сообщения поддержки
```

**Критерии успеха:**
- Система стабильно работает под нагрузкой
- Корректно обрабатывает входящие данные
- Latency < 10 секунд для 99% запросов

#### 1.3. Что входит в скоуп проекта/итерации, что не входит

**Входит:**
- Обучение модели классификации тональности
- Инференс в реальном времени
- Отправка сообщений поддержки

**Не входит:**
- Генерация персонализированных ответов
- Поддержка мультиязычности (только English v1)
- Детекция сарказма

**Техдолг:**
- Отсутствие полноценного мониторинга качества в v1

#### 1.4. Предпосылки решения

- Используются только текстовые данные
- Горизонт прогноза — моментальный
- Гранулярность — один комментарий
- Обучение на размеченном датасете (Cyberbullying Classification)

---

### 2. Методология Data Scientist

#### 2.1. Постановка задачи

**Бинарная классификация** на позитивный/негативный текст комментария.

**Агрегация классов (Cyberbullying Dataset):**
- `no_cyberbullying` → 0 (позитивный/нейтральный)
- `religion, race, ideology, sexual, other` → 1 (негативный)

#### 2.2. Блок-схема решения

```
1. Загрузка данных (Kaggle CSV)
       ↓
2. EDA (распределения, баланс, пропуски)
       ↓
3. Препроцессинг текста (tokenization, cleaning)
       ↓
4. Feature Extraction (TF-IDF / embeddings)
       ↓
5. Обучение модели (LogReg / BERT)
       ↓
6. Валидация (cross-validation, metrics)
       ↓
7. Инференс (API endpoint)
       ↓
8. Отправка сообщения поддержки
```

#### 2.3. Этапы решения задачи Data Scientist

| Этап | Данные | Техника | Результат |
|------|--------|---------|-----------|
| **1. Подготовка данных** | Cyberbullying Dataset (47K твитов) | Загрузка CSV, агрегация классов | Витрина: text, label (0/1) |
| **2. EDA** | Витрина из этапа 1 | Визуализация, статистика | Отчёт: распределения, инсайты |
| **3. Препроцессинг** | Тексты | Lowercase, remove URLs, токенизация | Очищенные тексты |
| **4. Feature Engineering** | Очищенные тексты | TF-IDF / BERT embeddings | Feature матрица |
| **5. Моделирование** | Features + labels | Logistic Regression / Random Forest / BERT | Обученные модели |
| **6. Валидация** | Train/test split | Cross-validation, metrics | Метрики: accuracy, precision, recall, F1 |
| **7. Инференс** | Лучшая модель | FastAPI сервис | API endpoint |

**Формирование выборки:**
- Train: 70%
- Validation: 15%
- Test: 15%
- Стратификация по классам

**Метрики качества:**

| Метрика | Target | Обоснование |
|---------|--------|-------------|
| **Precision** | > 0.7 | Минимизировать ложные срабатывания (не спамить поддержкой) |
| **Recall** | > 0.6 | Не пропускать пользователей в беде |
| **F1-Score** | > 0.65 | Баланс precision/recall |
| **Accuracy** | > 0.7 | Общая точность |

**Риски этапа моделирования:**
- Дисбаланс классов после агрегации → SMOTE / class weights
- Недостаточное качество простых моделей → Переход на transformers

---

### 3. Подготовка пилота

#### 3.1. Способ оценки пилота

**A/B тест:**
- **Группа A (control):** Все грустные (baseline)
- **Группа B (treatment):** ML классификация

#### 3.2. Что считаем успешным пилотом

| Критерий | Target |
|----------|--------|
| Время ответа | < 10 сек (p99) |
| Precision | > baseline (по экспертной оценке) |
| Recall | > baseline (не хуже 100% recall baseline) |
| F1-Score | > 0.65 |

#### 3.3. Подготовка пилота

**Вычислительная сложность:**

| Модель | Inference time (est.) | Требования |
|--------|----------------------|------------|
| Logistic Regression | ~10ms | CPU, 1 core |
| Random Forest | ~50ms | CPU, 1 core |
| BERT (distilled) | ~100ms | CPU/GPU recommended |

**Ограничения для пилота:**
- Максимум 100 req/sec
- 1 сервер (2 CPU cores, 4GB RAM)
- Без GPU для v1

---

### 4. Внедрение

#### 4.1. Архитектура решения

```
                    ┌─────────────────┐
                    │   Load Balancer │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
    ┌─────────▼─────────┐       ┌──────────▼──────────┐
    │   API Gateway     │       │   Rate Limiter      │
    │   (FastAPI)       │       │   (Redis)           │
    └─────────┬─────────┘       └─────────────────────┘
              │
    ┌─────────▼─────────┐
    │   Sentiment       │
    │   Classifier      │
    │   (ML Model)      │
    └─────────┬─────────┘
              │
    ┌─────────▼─────────┐
    │   Message         │
    │   Dispatcher      │
    └─────────┬─────────┘
              │
    ┌─────────▼─────────┐
    │   Support         │
    │   Message DB      │
    └───────────────────┘
```

**API Methods:**
- `POST /api/v1/classify` — классификация комментария
- `GET /api/v1/health` — health check

#### 4.2. Описание инфраструктуры и масштабируемости

**Инфраструктура v1:**
- FastAPI приложение
- Docker контейнер
- 1 реплика (масштабирование горизонтальное при нагрузке)

**Масштабируемость:**
- Horizontal scaling через Kubernetes/Docker Swarm
- Redis для кэширования и rate limiting
- Queue (Celery) для асинхронной обработки

#### 4.3. Требования к работе системы

| Параметр | Значение |
|----------|----------|
| **SLA** | 99% uptime |
| **Пропускная способность** | < 100 req/sec (v1) |
| **Latency** | p99 < 10 секунд |
| **Error rate** | < 1% |

#### 4.4. Безопасность системы

- HTTPS для всех endpoints
- API key аутентификация
- Input валидация (XSS, injection prevention)

#### 4.5. Безопасность данных

- Публичный датасет (без персональных данных)
- Не храним исходные комментарии после обработки
- GDPR compliance (если работаем с EU users)

#### 4.6. Издержки

| Компонент | Стоимость (мес, est.) |
|-----------|----------------------|
| Сервер инференса (2 CPU, 4GB) | ~$20-50 |
| Redis (cache) | ~$10-20 |
| Domain + SSL | ~$5 |
| **Итого** | **~$35-75/мес** |

#### 4.7. Integration Points

| Точка интеграции | Описание |
|------------------|----------|
| **API входящих комментариев** | Webhook от платформы (Reddit/Twitter API) |
| **API отправки ответов** | Email SMTP / Platform messaging API |

#### 4.8. Риски

| Риск | Последствие | Действие |
|------|-------------|----------|
| Сленг | Ошибки классификации | Дообучение на сленг-корпусе |
| Другой язык | Невозможность классификации | Языковой фильтр на входе |
| Большой поток | Перегруз сервиса | Очереди, rate limiting |
| Злоупотребление | Перегруз сервиса | Rate limit per user/IP |
| Ложные корреляции | Неверные ответы | Анализ feature importance |
| Дрейф данных | Потеря качества | Мониторинг, план переобучения |
| Модель деградирует | Ложные срабатывания | A/B тесты, canary deployment |
