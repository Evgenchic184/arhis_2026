# ML System Design Doc - [RU]
## Дизайн ML системы - \<Продукт\> \<MVP or Production System\> \<Номер\>

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*   

- Рекомендации по процессу заполнения документа (workflow) - [здесь](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Workflow.md).  
- Детальный доклад о том, что такое ML System Design Doc и о том, как, когда и зачем его составлять - [тут](https://www.youtube.com/watch?v=PW9TGNr1Vqk).
    
> ## Термины и пояснения
> - Итерация - это все работы, которые совершаются до старта очередного пилота  
> - БТ - бизнес-требования 
> - EDA - Exploratory Data Analysis - исследовательский анализ данных  
> - `Product Owner`,  `Data Scientist` - роли, которые заполняют соответствующие разделы 
> - В этом шаблоне роль `Data Scientist` совмещает в себе компетенции классического `Data Scientist` с упором на исследования и `ML Engineer` & `ML Ops` роли с акцентом на продуктивизацию моделей
> - Для вашей организации распределение ролей может быть уточнено в зависимости от операционной модели 

### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

Автоматически выявлять пользователей с негативным эмоциональным состоянием по комментариям и отправлять им поддерживающие сообщения.  

Без ML невозможно масштабировать ручную модерацию комментариев. ML позволяет обрабатывать большой поток данных в реальном времени.  

Система классифицирует комментарии с приемлемой точностью и отправляет поддерживающие фразы не более чем за 5–10 секунд.  


#### 1.2. Бизнес-требования и ограничения  

Определять настроение пользователя по комментарию.
Отправлять фразу поддержки всем пользователям с негативным настроением.   

Ограничения:  
- Время ответа  5-10 секунд.  
- Онлайн-режим работы.  
- В версии v0 все комментарии считаются грустными (baseline).  

Комментарий -> классификация -> отправка сообщения поддержки.  

Система стабильно работает под нагрузкой и корректно обрабатывает входящие данные.  

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

Входит:  
- Обучение модели классификации тональности.  
- Инференс в реальном времени.  
- Отправка сообщений поддержки.  

Не входит:  
- Генерация персонализированных ответов.  
- Поддержка мультиязычности.  
- Детекция сарказма.  

Техдолг:  
- Отсутствие полноценного мониторинга качества.   

#### 1.4. Предпосылки решения  

Используются только текстовые данные.  
Горизонт прогноза - моментальный.  
Гранулярность - один комментарий.  
Обучение на размеченном датасете Reddit.  

### 2. Методология `Data Scientist`     

#### 2.1. Постановка задачи  

Бинарная классификация на позитивный/не_позитивный текст комментария.

#### 2.2. Блок-схема решения  

1) Загрузка данных  
2) EDA  
3) Препроцессинг текста  
4) Обучение модели  
5) Валидация  
6) Инференс  
7) Отправка сообщения поддержки  

#### 2.3. Этапы решения задачи `Data Scientist`  

![task_stages](task_stages.png)

- Для каждого этапа **по результатам EDA** описываем - **отдельно для бейзлайна** и **отдельно для основного MVP** - все про данные и технику решения максимально конкретно. Обозначаем необходимые вводные, технику предполагаемого решения и что ожидаем получить на выходе, чтобы перейти к следующему этапу.  
- Как правило, детальное и структурированное заполнение раздела `2.3` возможно только **по результатам EDA**.  
- Если описание в дизайн доке **шаблонно** - т.е. его можно скопировать и применить к разным продуктам, то оно **некорректно**. Дизайн док должен показывать схему решения для конкретной задачи, поставленной в части 1.  
    
> Примеры этапов:  
> - Этап 2 - Подготовка прогнозных моделей  
> - Этап 3 - Интерпретация моделей (согл. с заказчиком)  
> - Этап 4 - Интеграция бизнес правил для расчета бизнес-метрик качества модели  
> - Этап 5 - Подготовка инференса модели по итерациям    
> - Этап 6 - Интеграция бизнес правил  
> - Этап 7 - Разработка оптимизатора (выбор оптимальной итерации)  
> - Этап 8 - Подготовка финального отчета для бизнеса  

*Этап 1 - это обычно, подготовка данных.*  

В этом этапе должно быть следующее:  

- Данные и сущности, на которых будет обучаться ваша модель машинного обучения. Отдельная таблица для целевой переменной (либо целевых переменных разных этапов), отдельная таблица – для признаков.  
  
| Название данных | Есть ли данные в компании (если да, название источника/витрин) | Требуемый ресурс для получения данных (какие роли нужны) | Проверено ли качество данных (да, нет) |
| --------------- | -------------------------------------------------------------- | -------------------------------------------------------- | -------------------------------------- |
| Продажи         | DATAMARTS_SALES_PER_DAY                                        | DE/DS                                                    | +                                      |
| ...             | ...                                                            | ...                                                      | ...                                    |
 
- Краткое описание результата этапа - что должно быть на выходе: витрины данных, потоки данных, др.  
  
> Чаще всего заполнение раздела невозможно без EDA.

 *Этапы 2 и далее, помимо подготовки данных.*
 
Описание техники **для каждого этапа** должно включать описание **отдельно для MVP** и **отдельно для бейзлайна**:  

- Описание формирования выборки для обучения, тестирования и валидации. Выбор репрезентативных данных для экспериментов, обучения и подготовки пилота (от бизнес-цели и репрезентативности данных с технической точки зрения) `Data Scientist`    
- Горизонт, гранулярность, частоту необходимого пересчета прогнозных моделей `Data Scientist`   
- Определение целевой переменной, согласованное с бизнесом `Data Scientist`   
- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`   
- Необходимый результат этапа. Например, необходимым результатом может быть не просто достижение каких-либо метрик качества, а включение в модели определенных факторов (флаг промо для прогноза выручки, др.) `Data Scientist`    
- Какие могут быть риски и что планируем с этим делать. Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`    
- Верхнеуровневые принципы и обоснования для: feature engineering, подбора алгоритма решения, техники кросс-валидации, интерпретации результата (если применимо).  
- Предусмотрена ли бизнес-проверка результата этапа и как будет проводиться `Data Scientist` & `Product Owner`  
  
### 3. Подготовка пилота  
  
#### 3.1. Способ оценки пилота  
  
A/B тест:
- A: все грустные  
- B: ML классификация  

#### 3.2. Что считаем успешным пилотом  
  
Время ответа < 10 сек.  
Метрика > baseline.  
  
#### 3.3. Подготовка пилота  
  
- Что можем позволить себе, исходя из ожидаемых затрат на вычисления. Если исходно просчитать сложно, то описываем этап расчетов ожидаемой вычислительной сложности на эксперименте с бейзлайном. И предусматриваем уточнение параметров пилота и установку ограничений по вычислительной сложности моделей. `Data Scientist` 

### 4. Внедрение `для production систем, если требуется`    

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.  
  
#### 4.1. Архитектура решения   
  
- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`  
  
#### 4.2. Описание инфраструктуры и масштабируемости 
  
- FastAPI
- Docker
- Очередь
  
#### 4.3. Требования к работе системы  

SLA 99%
< 100 req/sec
latency < 10  
  
#### 4.4. Безопасность системы  
  

  
#### 4.5. Безопасность данных   
  
- Публичный датасет
- Без персональных данных 
  
#### 4.6. Издержки  
  
- Сервер инференса 
  
#### 4.5. Integration points  
  
- API входящих комментариев  
- API отправки ответов  
  
#### 4.6. Риски  
  
| Риск              | Последствие     | Действие         |
| ----------------- | --------------- | ---------------- |
| Сленг             | Ошибки          | Дообучение       |
| Другой язык       | Ошибки          | Фильтр языка     |
| Большой поток     | Перегруз        | Очереди          |
| Злоупотребление   | Перегруз        | Rate limit       |
| Ложные корреляции | Неверные ответы | Анализ признаков |
| Дрейф данных      | Потеря качества | Мониторинг       |
| Замена символов   | Ошибки          | Фильтр символов  |
  
