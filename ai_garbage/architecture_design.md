# Архитектура системы Toxic Detection

## 📋 Что такое "Архитектура системы" для Checkpoint 1?

Согласно **task.md (Чекпоинт 1, пункт 4)**:

> **Диаграмма архитектуры до выбора конкретных инструментов**
> - Источники данных
> - Обработка
> - Хранение
> - Модель
> - API / пользовательский интерфейс

**Важно:** Для Чекпоинта 1 нужна **высокоуровневая архитектура**, а не детальная реализация.

---

## 🎯 Два уровня архитектуры

### Уровень 1: ML Pipeline (для разработки модели)

**Для чего:** Описать процесс создания ML-модели (Checkpoint 1-3)

**Аудитория:** Data Scientist, руководитель проекта

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Источники     │────▶│   Обработка     │────▶│   Хранение      │
│   данных        │     │   данных        │     │   (витрины)     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                      │
                                                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Инференс      │◀────│   Модель        │◀────│   Обучение      │
│   (API)         │     │   (ML)          │     │   модели        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

---

### Уровень 2: Production Architecture (для интеграции)

**Для чего:** Описать, как система работает в production (Checkpoint 4)

**Аудитория:** ML Engineer, DevOps, разработчики платформы

```
┌─────────────────────────────────────────────────────────────────┐
│                        Reddit-like Platform                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Toxic Detection System                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   API       │  │   ML        │  │   Decision              │  │
│  │   Gateway   │──│   Model     │──│   Engine                │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Moderation Actions                            │
│  [Block]  [Flag for Review]  [Allow]                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ Полная архитектура (оба уровня)

### Для Checkpoint 1 (высокоуровневая):

```
┌──────────────────────────────────────────────────────────────────────┐
│                         ARCHITECTURE OVERVIEW                         │
└──────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│  DATA SOURCES   │
│                 │
│  • Kaggle       │  (Cyberbullying Dataset)
│  • Reddit API   │  (будущие данные)
│  • User Input   │  (комментарии в реальном времени)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  DATA PIPELINE  │
│                 │
│  • Загрузка     │
│  • Валидация    │
│  • Препроцессинг│
│  • Агрегация    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│  DATA STORAGE   │      │  FEATURE STORE  │
│                 │      │                 │
│  • Raw Data     │      │  • TF-IDF       │
│  • Processed    │      │  • Embeddings   │
│  • Train/Test   │      │  • (offline)    │
└────────┬────────┘      └────────┬────────┘
         │                        │
         │                        ▼
         │               ┌─────────────────┐
         │               │  MODEL TRAINING │
         │               │                 │
         │               │  • LogReg       │
         │               │  • Random Forest│
         │               │  • BERT         │
         └──────────────▶│  • Validation   │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  MODEL REGISTRY │
                         │                 │
                         │  • Versioning   │
                         │  • Metrics      │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  MODEL SERVING  │
                         │                 │
                         │  • FastAPI      │
                         │  • Inference    │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  DECISION       │
                         │  ENGINE         │
                         │                 │
                         │  • Rules        │
                         │  • Actions      │
                         └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  MODERATION     │
                         │  ACTIONS        │
                         │                 │
                         │  • Block        │
                         │  • Flag         │
                         │  • Allow        │
                         └─────────────────┘
```

---

## 📦 Компоненты архитектуры (детально)

### 1. Источники данных (Data Sources)

| Источник | Тип данных | Частота | Объём |
|----------|-----------|---------|-------|
| **Kaggle Dataset** | CSV (tweet_text, cyberbullying_type) | Единоразово | 47K строк |
| **Reddit API** (future) | JSON (comments, posts) | Real-time | Поток |
| **User Input** | Текст комментария | Real-time | 1 запрос |

**Для v1:** Только Kaggle Dataset (обучение модели)

---

### 2. Обработка данных (Data Pipeline)

```
┌─────────────────────────────────────────────────────────────┐
│                    DATA PIPELINE (ETL)                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. EXTRACT                                                  │
│     └─ Загрузка CSV из Kaggle                               │
│                                                              │
│  2. TRANSFORM                                                │
│     ├─ Валидация схемы (tweet_text, cyberbullying_type)     │
│     ├─ Проверка пропусков (0% допустимо)                    │
│     ├─ Удаление дубликатов (<5%)                            │
│     ├─ Создание признака is_toxic (binary mapping)          │
│     ├─ Препроцессинг текста (lowercase, remove URLs)        │
│     └─ Токенизация (TF-IDF / BERT tokenizer)                │
│                                                              │
│  3. LOAD                                                     │
│     ├─ Сохранение processed data (Parquet/CSV)              │
│     ├─ Сплит train/validation/test (70/15/15)               │
│     └─ Загрузка в Feature Store                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Инструменты для v1:**
- Python (pandas)
- Scikit-learn (TF-IDF)
- Локальное хранилище (файлы)

**Инструменты для production:**
- Apache Airflow / Prefect (оркестрация)
- Apache Spark (обработка)
- S3 / GCS (хранилище)

---

### 3. Хранение данных (Data Storage)

```
┌─────────────────────────────────────────────────────────────┐
│                     DATA STORAGE LAYER                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐                                        │
│  │  RAW DATA       │  (исходные данные)                    │
│  │  • cyberbullying.csv                                    │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  PROCESSED DATA │  (после ETL)                          │
│  │  • train.parquet                                        │
│  │  • val.parquet                                          │
│  │  • test.parquet                                         │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  FEATURE STORE  │  (признаки для моделей)               │
│  │  • TF-IDF vectors (offline)                             │
│  │  • Text embeddings (offline)                            │
│  └─────────────────┘                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Для v1:** Локальные файлы (CSV, Parquet)

**Для production:**
- Data Lake (S3)
- Feature Store (Feast, Tecton)
- Online Store (Redis) для инференса

---

### 4. Обучение модели (Model Training)

```
┌─────────────────────────────────────────────────────────────┐
│                    MODEL TRAINING PIPELINE                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐                                        │
│  │  EXPERIMENT     │  (эксперименты)                       │
│  │  TRACKING       │                                        │
│  │  • MLflow       │  (параметры, метрики)                 │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  MODEL          │  (обучение)                           │
│  │  TRAINING       │                                        │
│  │  • Logistic Regression (baseline)                       │
│  │  • Random Forest                                        │
│  │  • BERT (advanced)                                      │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  VALIDATION     │  (валидация)                          │
│  │                 │                                        │
│  │  • Cross-validation (K=5)                               │
│  │  • Metrics: Precision, Recall, F1, ROC-AUC              │
│  └─────────────────┘                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Метрики для v1:**
- Precision > 0.85 (минимизировать ложные блокировки)
- Recall > 0.75 (ловить токсичные)
- F1 > 0.80

---

### 5. Модель (Model Serving)

```
┌─────────────────────────────────────────────────────────────┐
│                      MODEL SERVING                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐                                        │
│  │  MODEL          │  (реестр моделей)                     │
│  │  REGISTRY       │                                        │
│  │  • Version: v1.0                                        │
│  │  • Metrics: F1=0.82                                     │
│  │  • Artifacts: model.pkl, vectorizer.pkl                 │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  INFERENCE      │  (API для предсказаний)               │
│  │  API            │                                        │
│  │  • POST /api/v1/predict                                 │
│  │  • Input: {"text": "..."}                               │
│  │  • Output: {"is_toxic": true, "confidence": 0.87}       │
│  └─────────────────┘                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Инструменты для v1:**
- FastAPI (API сервер)
- Pickle/Joblib (сериализация модели)
- Docker (контейнеризация)

---

### 6. Decision Engine

```
┌─────────────────────────────────────────────────────────────┐
│                      DECISION ENGINE                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Правила принятия решений:                                   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  IF toxic_probability > 0.70                         │   │
│  │    THEN BLOCK                                        │   │
│  │                                                      │   │
│  │  IF toxic_probability > 0.40 AND < 0.70              │   │
│  │    THEN FLAG_FOR_REVIEW                              │   │
│  │                                                      │   │
│  │  IF toxic_probability < 0.40                         │   │
│  │    THEN ALLOW                                        │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  Действия:                                                   │
│  • BLOCK → Скрыть комментарий                               │
│  • FLAG → Отправить модератору                              │
│  • ALLOW → Опубликовать                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 7. Moderation Actions (Интеграция с платформой)

```
┌─────────────────────────────────────────────────────────────┐
│              INTEGRATION WITH REDDIT-LIKE PLATFORM           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐                                        │
│  │  Reddit         │                                        │
│  │  Platform       │                                        │
│  │  API            │                                        │
│  └────────┬────────┘                                        │
│           │                                                  │
│           │ POST /api/v1/moderate                            │
│           │ {                                                │
│           │   "comment_id": "abc123",                        │
│           │   "text": "...",                                 │
│           │   "action": "block" | "flag" | "allow"           │
│           │ }                                                │
│           ▼                                                  │
│  ┌─────────────────┐                                        │
│  │  Moderation     │                                        │
│  │  Dashboard      │  (для модераторов)                    │
│  │                 │                                        │
│  │  • Queue: flagged comments                              │
│  │  • Review: approve/reject                               │
│  │  • Analytics: toxicity trends                           │
│  └─────────────────┘                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 Data Flow Diagram (DFD)

### Уровень 0 (Context Diagram):

```
┌──────────────┐
│   Reddit     │
│   Platform   │
└──────┬───────┘
       │ Комментарий
       ▼
┌──────────────────────────────┐
│                              │
│   TOXIC DETECTION SYSTEM     │
│                              │
└──────┬───────────────────────┘
       │ Решение (block/flag/allow)
       ▼
┌──────────────┐
│   Reddit     │
│   Platform   │
└──────────────┘
```

### Уровень 1 (Major Processes):

```
                    ┌──────────────┐
                    │   Reddit     │
                    │   Platform   │
                    └──────┬───────┘
                           │ 1. Комментарий
                           ▼
              ┌────────────────────────┐
              │  1. API Gateway        │
              │     (валидация)        │
              └───────────┬────────────┘
                          │ 2. Текст
                          ▼
              ┌────────────────────────┐
              │  2. ML Model           │
              │     (инференс)         │
              └───────────┬────────────┘
                          │ 3. toxic_probability
                          ▼
              ┌────────────────────────┐
              │  3. Decision Engine    │
              │     (правила)          │
              └───────────┬────────────┘
                          │ 4. Решение
                          ▼
              ┌────────────────────────┐
              │  4. Moderation         │
              │     (действие)         │
              └───────────┬────────────┘
                          │ 5. Результат
                          ▼
                    ┌──────────────┐
                    │   Reddit     │
                    │   Platform   │
                    └──────────────┘
```

---

## 📊 Архитектура для ML System Design Doc

Заполни раздел **4.1. Архитектура решения** в `system_design_template.md`:

```
4.1. Архитектура решения

Блок-схема:

[User: Комментарий] 
       │
       ▼
[API Gateway: FastAPI]
       │
       ▼
[ML Model: Toxic Classifier]
       │
       ▼
[Decision Engine: Rules]
       │
       ▼
[Moderation: Block/Flag/Allow]

Компоненты:
1. API Gateway — приём комментариев, валидация
2. ML Model — предсказание токсичности (LogReg/BERT)
3. Decision Engine — правила (пороги, действия)
4. Moderation — интеграция с платформой
```

---

## 🎯 Что нужно для Checkpoint 1?

### Обязательно (согласно task.md):

1. **Диаграмма архитектуры** (высокоуровневая, без инструментов)
   - Источники данных → Обработка → Хранение → Модель → API
2. **Описание компонентов** (1-2 предложения на каждый)
3. **DFD** (Data Flow Diagram) — как данные движутся

### Не обязательно для Checkpoint 1:

- Детальная реализация (FastAPI, Docker, etc.)
- Интеграция с Reddit API
- Production инфраструктура (Kubernetes, Redis, etc.)

---

## 💡 Рекомендация

Для **Checkpoint 1** нарисуй **2 диаграммы**:

### 1. ML Pipeline (для разработки):

```
Data Sources → ETL → Storage → Training → Model
```

### 2. Inference Pipeline (для production):

```
User Comment → API → ML Model → Decision → Action
```

Это покажет, что ты понимаешь **разницу между обучением модели и её эксплуатацией**.

---

**Вопрос:** Нужно ли нарисовать эти диаграммы визуально (в draw.io / Miro) или достаточно текстового описания в документе?
